<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hospice Facility Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            display: flex;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        #map-container {
            flex: 3;
        }

        #map {
            height: 600px;
            border: 2px solid #00ff99;
            border-radius: 8px;
        }

        #info-panel {
            flex: 1;
            margin-left: 20px;
            padding: 15px;
            background-color: #1e1e1e;
            border: 2px solid #00ff99;
            border-radius: 8px;
            display: none;
        }

        #info-content p {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        h1, h2 {
            color: #00ff99;
        }

        p {
            color: #cccccc;
        }

        .leaflet-container {
            background: #1e1e1e;
        }

        #reset-zoom {
            margin-top: 10px;
            background-color: #00ff99;
            color: #121212;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        #reset-zoom:hover {
            background-color: #00cc77;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <h1>Hospice Facility Map</h1>
        <p>This map shows the geographic distribution of hospices in the dataset.</p>
        <input type="text" id="search-box" placeholder="Search by Facility Name" style="width: 70%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #00ff99; background-color: #1e1e1e; color: #e0e0e0;">
        <div id="suggestions" style="position: relative; width: 70%; background-color: #1e1e1e; border: 1px solid #00ff99; border-top: none; max-height: 150px; overflow-y: auto; display: none; color: #e0e0e0;"></div>
        <button id="search-button" style="padding: 8px 12px; border-radius: 4px; border: none; background-color: #00ff99; color: #121212; cursor: pointer;">Search</button>
        <div id="map"></div>
        <button id="reset-zoom">Reset Zoom</button>
        <button id="reset-markers" style="margin-left: 10px; background-color: #00ff99; color: #121212; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">Reset Markers</button>

    </div>
    <div id="info-panel">
        <h2>Facility Details <span id="close-info" style="cursor:pointer; float:right;">✖</span></h2>
        <div id="info-content">Click on a facility to view details here.</div>
    </div>    

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const csvFile = 'data/clean_data.csv';

        const initialView = [37.8, -96];
        const initialZoom = 4;
        const map = L.map('map').setView(initialView, initialZoom);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap contributors, © Carto'
        }).addTo(map);

        const colorScale = d3.scaleLinear().domain([0, 10]).range(["#800080", "#ffff66"]);

        const infoPanel = document.getElementById('info-panel');
        const infoContent = document.getElementById('info-content');

        function formatValue(value) {
            if (value === undefined || value === null || value.trim() === '' || value === '0' || value === 'NaN') {
                return 'Not Available';
            }
            return value;
        }

        d3.csv(csvFile).then(data => {
            let activeMarker = null;
            let clickedMarkers = [];
            const markerMap = {};
            let facilityNames = []; //adding autocomplete to search bar

            data.forEach(d => {
                const lat = +d.Latitude;
                const lon = +d.Longitude;
                const indexScore = +d['Hospice Care Index Overall Score'];

                if (!isNaN(lat) && !isNaN(lon) && !isNaN(indexScore)) {
                    const color = colorScale(indexScore);

                    const marker = L.circleMarker([lat, lon], {
                        radius: 6,
                        fillColor: color,
                        originalColor: color,
                        fillOpacity: 0.9,
                        weight: 0
                    });

                    marker.bindTooltip(`<strong>${d['Facility Name']}</strong><br>${d['City/Town']}, ${d['State']}<br> Hospice Care Score: ${indexScore}/10`, {
                        direction: 'top',
                        offset: [0, -5],
                        opacity: 0.9
                    });

                    marker.on('mouseover', function () {
                        this.setStyle({ radius: 10 });
                    });

                    marker.on('mouseout', function () {
                        if (this !== activeMarker) {
                            this.setStyle({ radius: 6 });
                        }
                    });

                    marker.on('click', function () {
                    //setting marker back to original format after click
                    clickedMarkers.push(this);
                    if (activeMarker && activeMarker !== this) {
                        activeMarker.setStyle({ weight: 0, radius: 6 });
                    }

                    //making clicked marker have a green border and icnreased size
                    this.setStyle({weight:1, color:'#ffffff', fillColor: '#00ff99', radius: 13 });
                    activeMarker = this;

                    // Show info in the side panel
                    infoPanel.style.display = 'block';
                    infoContent.innerHTML = `
                    <p><strong>Facility Name:</strong> ${formatValue(d['Facility Name'])}</p>
                    <p><strong>Address:</strong> ${formatValue(d['Address Line 1'])}, ${formatValue(d['City/Town'])}, ${formatValue(d['State'])}</p>
                    <p><strong>Average Percent of Patient Days with Continuous Homecare:</strong> ${formatValue(d['CHC/GIP provided (% days)'])}%</p>
                    <p><strong>Hospice Care Score:</strong> ${formatValue(d['Hospice Care Index Overall Score'])}/10.0</p>
                    <p><strong>Average Nurse Care Time:</strong> ${formatValue(d['Nurse care minutes per routine home care days (minutes)'])} Minutes</p>
                    <p><strong>Per-Beneficiary Spending (USD):</strong> $${formatValue(d['Per-beneficiary spending (U.S. dollars $)'])}</p>
                `;

                });

                    marker.addTo(map);
                    markerMap[d['Facility Name'].toLowerCase()] = marker;
                    facilityNames.push(d['Facility Name']);
                }
            });

                    //adding an exit feature on the side-bar to clear selection
                    document.getElementById('close-info').addEventListener('click', () => {
                    if (activeMarker) {
                        activeMarker.setStyle({ weight: 0, radius: 6 });
                        activeMarker = null;
                    }

                    infoPanel.style.display = 'none';
                    map.setView(initialView, initialZoom);
                    document.getElementById('search-box').value = '';
                    document.getElementById('suggestions').style.display = 'none';
                });

                    const searchBox = document.getElementById('search-box');
                    const suggestionsBox = document.getElementById('suggestions');

                    searchBox.addEventListener('input', function () {
                        const query = this.value.toLowerCase();
                        suggestionsBox.innerHTML = '';
                        if (query.length === 0) {
                            suggestionsBox.style.display = 'none';
                            return;
                        }

                        const filtered = facilityNames.filter(name => name.toLowerCase().includes(query));
                        if (filtered.length === 0) {
                            suggestionsBox.style.display = 'none';
                            return;
                        }

                        filtered.forEach(name => {
                            const div = document.createElement('div');
                            div.textContent = name;
                            div.style.padding = '5px';
                            div.style.cursor = 'pointer';
                            div.addEventListener('click', () => {
                                searchBox.value = name;
                                suggestionsBox.style.display = 'none';
                                const marker = markerMap[name.toLowerCase()];
                                if (marker) {
                                    marker.fire('click');
                                    map.setView(marker.getLatLng(), 12);
                                }
                            });
                            suggestionsBox.appendChild(div);
                        });

                        suggestionsBox.style.display = 'block';
                    });

                //now making the reset markers button handler
                document.getElementById('reset-markers').addEventListener('click', () => {
                    clickedMarkers.forEach(marker => {
                        marker.setStyle({
                            weight: 0,
                            radius: 6,
                            fillColor: marker.options.originalColor
                        });
                    });
                    clickedMarkers = [];
                    activeMarker = null;
                    infoPanel.style.display = 'none';
                });

        });

        //creating map legend
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            const grades = [0, 2, 4, 6, 8, 10];
            div.style.background = '#1e1e1e';
            div.style.padding = '10px';
            div.style.border = '2px solid #00ff99';
            div.style.borderRadius = '5px';
            div.style.color = '#e0e0e0';
            div.innerHTML += '<strong>Hospice Index Score</strong><br>';
            grades.forEach((grade, i) => {
                const color = colorScale(grade);
                div.innerHTML += `<i style="background:${color}; width: 18px; height: 18px; display: inline-block; margin-right: 5px;"></i> ${grade}${grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+'}`;
            });
            return div;
        };
        legend.addTo(map);

        //making reset zoom button handler
        document.getElementById('reset-zoom').addEventListener('click', () => {
            map.setView(initialView, initialZoom);
        });




        //adding search bar feature for specific hospices

        document.getElementById('search-button').addEventListener('click', () => {
            const query = document.getElementById('search-box').value.trim().toLowerCase();
            const marker = markerMap[query];

            if (marker) {
                marker.fire('click');
                map.setView(marker.getLatLng(), 12);
            } else {
                alert('Facility not found. Please check the name and try again.');
            }
        });

        //autocomplete handler
        document.addEventListener('click', function (event) {
            if (event.target !== searchBox && event.target.parentNode !== suggestionsBox) {
                suggestionsBox.style.display = 'none';
            }
        });


    </script>
</body>
</html>



