<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hospice Facility Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            display: flex;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        #map-container {
            flex: 3;
        }

        #map {
            height: 600px;
            border: 2px solid #00ff99;
            border-radius: 8px;
        }

        #info-panel {
            flex: 1;
            margin-left: 20px;
            padding: 15px;
            background-color: #1e1e1e;
            border: 2px solid #00ff99;
            border-radius: 8px;
            display: none;
        }

        #info-content p {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        h1, h2 {
            color: #00ff99;
        }

        p {
            color: #cccccc;
        }

        .leaflet-container {
            background: #1e1e1e;
        }

        #reset-zoom {
            margin-top: 10px;
            background-color: #00ff99;
            color: #121212;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        #reset-zoom:hover {
            background-color: #00cc77;
        }
    </style>
</head>
<body>
    <div id="quiz-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#121212;color:#e0e0e0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;">
        <h1>How Do You Want Your Loved One to Spend Their Final Days?</h1>
        <p>Use the preferences below to find the right hospice for you</p>
        <label>
            State:
            <select id="state-level">
                <option value="any">No Preference</option>
                <option value="AL">AL</option>
                <option value="AK">AK</option>
                <option value="AZ">AZ</option>
                <option value="AR">AR</option>
                <option value="CA">CA</option>
                <option value="CO">CO</option>
                <option value="CT">CT</option>
                <option value="DE">DE</option>
                <option value="FL">FL</option>
                <option value="GA">GA</option>
                <option value="HI">HI</option>
                <option value="ID">ID</option>
                <option value="IL">IL</option>
                <option value="IN">IN</option>
                <option value="IA">IA</option>
                <option value="KS">KS</option>
                <option value="KY">KY</option>
                <option value="LA">LA</option>
                <option value="ME">ME</option>
                <option value="MD">MD</option>
                <option value="MA">MA</option>
                <option value="MI">MI</option>
                <option value="MN">MN</option>
                <option value="MS">MS</option>
                <option value="MO">MO</option>
                <option value="MT">MT</option>
                <option value="NE">NE</option>
                <option value="NV">NV</option>
                <option value="NH">NH</option>
                <option value="NJ">NJ</option>
                <option value="NM">NM</option>
                <option value="NY">NY</option>
                <option value="NC">NC</option>
                <option value="ND">ND</option>
                <option value="OH">OH</option>
                <option value="OK">OK</option>
                <option value="OR">OR</option>
                <option value="PA">PA</option>
                <option value="RI">RI</option>
                <option value="SC">SC</option>
                <option value="SD">SD</option>
                <option value="TN">TN</option>
                <option value="TX">TX</option>
                <option value="UT">UT</option>
                <option value="VT">VT</option>
                <option value="VA">VA</option>
                <option value="WA">WA</option>
                <option value="WV">WV</option>
                <option value="WI">WI</option>
                <option value="WY">WY</option>
            </select>
        </label>        
        <label>
            Continuous Home Care Provided?
            <select id="care-level">
                <option value="any">No Preference</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>
        </label>
        <label>
            Beliefs & Values Addressed (if desired by the patient):
            <select id="beliefs-level">
                <option value="any">No Preference</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select>
        </label>        
        <label>
            Spending Level (Per-Beneficiary):
            <select id="spending-level">
                <option value="any">Any</option>
                <option value="high">High</option>
                <option value="low">Low </option>
            </select>
        </label>
        <label>
            Amount of Visits in Last Days:
            <select id="visits-level">
                <option value="any">Any</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
        </label>
        <label>
            Hospice Overall Care Score:
            <select id="score-level">
                <option value="any">Any</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low </option>
            </select>
        </label>
        <button id="submit-quiz" style="margin-top:20px;padding:10px 20px;">View Matches</button>
    </div>
    <div id="map-container">
        <h1>Hospice Facility Map</h1>
        <p>This map shows the geographic distribution of hospices in the dataset.</p>
        <input type="text" id="search-box" placeholder="Search by Facility Name" style="width: 70%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #00ff99; background-color: #1e1e1e; color: #e0e0e0;">
        <div id="suggestions" style="position: relative; width: 70%; background-color: #1e1e1e; border: 1px solid #00ff99; border-top: none; max-height: 150px; overflow-y: auto; display: none; color: #e0e0e0;"></div>
        <button id="search-button" style="padding: 8px 12px; border-radius: 4px; border: none; background-color: #00ff99; color: #121212; cursor: pointer;">Search</button>
        <div id="map"></div>
        <button id="reset-zoom">Reset Zoom</button>
        <button id="reset-markers" style="margin-left: 10px; background-color: #00ff99; color: #121212; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">Reset Markers</button>
        <button id="show-all" style="margin-left: 10px; background-color: #00ff99; color: #121212; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;"> Clear Filters </button>
        <button id="take-quiz-again" style="margin-left: 10px; background-color: #00ff99; color: #121212; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">Take Quiz Again</button>



    </div>
    <div id="info-panel">
        <h2>Facility Details <span id="close-info" style="cursor:pointer; float:right;">✖</span></h2>
        <div id="info-content">Click on a facility to view details here.</div>
    </div>    

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const csvFile = 'data/clean_data.csv';

        const initialView = [37.8, -96];
        const initialZoom = 4;
        const map = L.map('map').setView(initialView, initialZoom);

        let allData = [];
        let activeMarker = null;
        let clickedMarkers = [];
        let markerMap = {};
        let facilityNames = [];


        d3.csv(csvFile).then(data => {
            allData = data;  // Store globally, don't render yet
        });


        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap contributors, © Carto'
        }).addTo(map);

        //QUIZ - adding in the quiz event handler here

        // Quiz Handler
        document.getElementById('submit-quiz').addEventListener('click', function() {
            const statePref = document.getElementById('state-level').value;
            const carePref = document.getElementById('care-level').value;
            const beliefsPref = document.getElementById('beliefs-level').value;
            const spendingPref = document.getElementById('spending-level').value;
            const visitsPref = document.getElementById('visits-level').value;
            const scorePref = document.getElementById('score-level').value;

            document.getElementById('quiz-overlay').style.display = 'none';

            const filtered = allData.filter(d => {
                const careValue = parseFloat(d['CHC/GIP provided (% days)']) || 0;
                const beliefsRaw = d['Beliefs & Values Addressed (if desired by the patient)'];
                let beliefsValue = -1;
                if (beliefsRaw && !isNaN(parseFloat(beliefsRaw))) {
                    beliefsValue = parseFloat(beliefsRaw);
                } else {
                    console.log("Invalid Beliefs & Values value:", JSON.stringify(beliefsRaw));
                }
                const spendingValue = parseFloat(d['Per-beneficiary spending (U.S. dollars $)'].replace(/[^0-9.]+/g, "")) || 0;
                const visitsRaw = d['Visits near death (% decedents)'];
                let visitsValue = -1;
                if (visitsRaw && !isNaN(parseFloat(visitsRaw))) {
                    visitsValue = parseFloat(visitsRaw);
                } else {
                    console.log("Invalid Visits Near Death value:", JSON.stringify(visitsRaw));
                }
                const scoreValue = parseFloat(d['Hospice Care Index Overall Score']) || 0;

                const stateMatch = statePref === 'any' || d['State'] === statePref;
                const careMatch = carePref === 'any' || 
                    (carePref === 'yes' && careValue > 0.1) || 
                    (carePref === 'no' && careValue <= 0.1);
                const beliefsMatch = beliefsPref === 'any' ||
                    (beliefsPref === 'yes' && beliefsValue > 1) ||
                    (beliefsPref === 'no' && beliefsValue <= 1);
                const spendingMatch = spendingPref === 'any' || (spendingPref === 'high' && spendingValue >= 9000) || (spendingPref === 'low' && spendingValue < 9000);
                const visitsMatch = visitsPref === 'any' ||
                    (visitsPref === 'high' && visitsValue >= 100) ||
                    (visitsPref === 'medium' && visitsValue >= 75 && visitsValue <= 100) ||
                    (visitsPref === 'low' && visitsValue < 75);
                const scoreMatch = scorePref === 'any' || (scorePref === 'high' && scoreValue >= 8) || (scorePref === 'medium' && scoreValue >= 5 && scoreValue < 8) || (scorePref === 'low' && scoreValue < 5);

                console.log("Visits Value:", visitsValue, "Pref:", visitsPref);

                return stateMatch && careMatch && beliefsMatch && spendingMatch && visitsMatch && scoreMatch;
            });

            clearAllMarkers();
            filtered.forEach(d => addInteractiveMarker(d));
        });




        const colorScale = d3.scaleLinear().domain([0, 10]).range(["#800080", "#ffff66"]);

        const infoPanel = document.getElementById('info-panel');
        const infoContent = document.getElementById('info-content');

        function formatValue(value) {
            if (value === undefined || value === null || value.trim() === '' || value === '0' || value === 'NaN') {
                return 'Not Available';
            }
            return value;
        }

        //creating helper function to save inital interactivity post quiz implementation
        function addInteractiveMarker(d) {
            const lat = +d.Latitude;
            const lon = +d.Longitude;
            const indexScore = +d['Hospice Care Index Overall Score'];

            if (!isNaN(lat) && !isNaN(lon) && !isNaN(indexScore)) {
                const color = colorScale(indexScore);
                const marker = L.circleMarker([lat, lon], {
                    radius: 6,
                    fillColor: color,
                    originalColor: color,
                    fillOpacity: 0.9,
                    weight: 0
                });

                marker.bindTooltip(`<strong>${d['Facility Name']}</strong><br>${d['City/Town']}, ${d['State']}<br> Hospice Care Score: ${indexScore}/10`, {
                    direction: 'top',
                    offset: [0, -5],
                    opacity: 0.9
                });

                marker.on('mouseover', function () {
                    this.setStyle({ radius: 10 });
                });

                marker.on('mouseout', function () {
                    if (this !== activeMarker) {
                        this.setStyle({ radius: 6 });
                    }
                });

                marker.on('click', function () {
                    clickedMarkers.push(this);
                    if (activeMarker && activeMarker !== this) {
                        activeMarker.setStyle({ weight: 0, radius: 6 });
                    }
                    this.setStyle({ weight: 1, color: '#ffffff', fillColor: '#00ff99', radius: 13 });
                    activeMarker = this;

                    infoPanel.style.display = 'block';
                    infoContent.innerHTML = `
                        <p><strong>Facility Name:</strong> ${formatValue(d['Facility Name'])}</p>
                        <p><strong>Address:</strong> ${formatValue(d['Address Line 1'])}, ${formatValue(d['City/Town'])}, ${formatValue(d['State'])}</p>
                        <p><strong>Average Percent of Patient Days with Continuous Homecare:</strong> ${formatValue(d['CHC/GIP provided (% days)'])}%</p>
                        <p><strong>Hospice Care Score:</strong> ${formatValue(d['Hospice Care Index Overall Score'])}/10.0</p>
                        <p><strong>Average Nurse Care Time:</strong> ${formatValue(d['Nurse care minutes per routine home care days (minutes)'])} Minutes</p>
                        <p><strong>Per-Beneficiary Spending (USD):</strong> $${formatValue(d['Per-beneficiary spending (U.S. dollars $)'])}</p>
                    `;
                });

                marker.addTo(map);
                markerMap[d['Facility Name'].toLowerCase()] = marker;
                facilityNames.push(d['Facility Name']);
            }
        }

        function clearAllMarkers() {
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });
            clickedMarkers = [];
            activeMarker = null;
        }


                    //adding an exit feature on the side-bar to clear selection
                    document.getElementById('close-info').addEventListener('click', () => {
                    if (activeMarker) {
                        activeMarker.setStyle({ weight: 0, radius: 6 });
                        activeMarker = null;
                    }

                    infoPanel.style.display = 'none';
                    map.setView(initialView, initialZoom);
                    document.getElementById('search-box').value = '';
                    document.getElementById('suggestions').style.display = 'none';
                });

                    const searchBox = document.getElementById('search-box');
                    const suggestionsBox = document.getElementById('suggestions');

                    searchBox.addEventListener('input', function () {
                        const query = this.value.toLowerCase();
                        suggestionsBox.innerHTML = '';
                        if (query.length === 0) {
                            suggestionsBox.style.display = 'none';
                            return;
                        }

                        const filtered = facilityNames.filter(name => name.toLowerCase().includes(query));
                        if (filtered.length === 0) {
                            suggestionsBox.style.display = 'none';
                            return;
                        }

                        filtered.forEach(name => {
                            const div = document.createElement('div');
                            div.textContent = name;
                            div.style.padding = '5px';
                            div.style.cursor = 'pointer';
                            div.addEventListener('click', () => {
                                searchBox.value = name;
                                suggestionsBox.style.display = 'none';
                                const marker = markerMap[name.toLowerCase()];
                                if (marker) {
                                    marker.fire('click');
                                    map.setView(marker.getLatLng(), 12);
                                }
                            });
                            suggestionsBox.appendChild(div);
                        });

                        suggestionsBox.style.display = 'block';
                    });

        //now making the reset markers button handler
                document.getElementById('reset-markers').addEventListener('click', () => {
                    clickedMarkers.forEach(marker => {
                        marker.setStyle({
                            weight: 0,
                            radius: 6,
                            fillColor: marker.options.originalColor
                        });
                    });
                    activeMarker = null;
                    infoPanel.style.display = 'none';
                });

        //making the remove filters button handler

                document.getElementById('show-all').addEventListener('click', () => {
                    clearAllMarkers();  // Clear any existing filtered markers
                    allData.forEach(d => addInteractiveMarker(d));  // Re-render all providers
                });

        //retake quiz handler

        document.getElementById('take-quiz-again').addEventListener('click', () => {
            clearAllMarkers();
            activeMarker = null;
            clickedMarkers = [];
            document.getElementById('quiz-overlay').style.display = 'flex';
            document.getElementById('info-panel').style.display = 'none';
            map.setView(initialView, initialZoom);
        });

        //creating map legend
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            const grades = [0, 2, 4, 6, 8, 10];
            div.style.background = '#1e1e1e';
            div.style.padding = '10px';
            div.style.border = '2px solid #00ff99';
            div.style.borderRadius = '5px';
            div.style.color = '#e0e0e0';
            div.innerHTML += '<strong>Hospice Index Score</strong><br>';
            grades.forEach((grade, i) => {
                const color = colorScale(grade);
                div.innerHTML += `<i style="background:${color}; width: 18px; height: 18px; display: inline-block; margin-right: 5px;"></i> ${grade}${grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+'}`;
            });
            return div;
        };
        legend.addTo(map);

        //making reset zoom button handler
        document.getElementById('reset-zoom').addEventListener('click', () => {
            map.setView(initialView, initialZoom);
        });




        //adding search bar feature for specific hospices

        document.getElementById('search-button').addEventListener('click', () => {
            const query = document.getElementById('search-box').value.trim().toLowerCase();
            const marker = markerMap[query];

            if (marker) {
                marker.fire('click');
                map.setView(marker.getLatLng(), 12);
            } else {
                alert('Facility not found. Please check the name and try again.');
            }
        });

        //autocomplete handler
        document.addEventListener('click', function (event) {
            if (event.target !== searchBox && event.target.parentNode !== suggestionsBox) {
                suggestionsBox.style.display = 'none';
            }
        });


    </script>
</body>
</html>



